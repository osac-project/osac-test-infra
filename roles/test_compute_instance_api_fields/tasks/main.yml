---
# Main tasks for ComputeInstance API fields testing
# Creates a ComputeInstance using explicit API fields, tests runStrategy mutability and immutability

- name: Generate unique instance name
  ansible.builtin.set_fact:
    test_instance_name: "e2e-test-api-fields-{{ 99999999 | random | string }}"

- name: Display test configuration
  ansible.builtin.debug:
    msg: |
      Creating test ComputeInstance with explicit API fields
      Instance name: {{ test_instance_name }}
      Namespace: {{ test_namespace }}
      Image: {{ test_image_ref }}
      Cores: {{ test_cores }}
      Memory: {{ test_memory_gib }} GiB
      Boot disk: {{ test_boot_disk_size }} GiB

- name: Create temporary directory for test manifests
  ansible.builtin.tempfile:
    state: directory
    prefix: osac-api-test-
  register: temp_dir

- name: Generate ComputeInstance manifest from template
  ansible.builtin.template:
    src: computeinstance.yml.j2
    dest: "{{ temp_dir.path }}/computeinstance.yml"
    mode: "0644"

- name: Create ComputeInstance using explicit API fields
  ansible.builtin.command:
    cmd: kubectl --as system:admin apply -f {{ temp_dir.path }}/computeinstance.yml
  register: create_result
  changed_when: create_result.rc == 0

- name: Display creation result
  ansible.builtin.debug:
    msg: "{{ create_result.stdout }}"

- name: Wait for provision job to appear
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ test_instance_name }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .jobID // ""
      '
  register: provision_job_poll
  changed_when: false
  until: provision_job_poll.stdout != ""
  retries: 30
  delay: 2

- name: Display provision job ID
  ansible.builtin.debug:
    msg: "Provision job started: {{ provision_job_poll.stdout }}"

- name: Wait for provision job to succeed
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ test_instance_name }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .state // ""
      '
  register: provision_success_poll
  changed_when: false
  until: provision_success_poll.stdout == 'Succeeded'
  retries: "{{ (provision_timeout / status_poll_interval) | int }}"
  delay: "{{ status_poll_interval }}"
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Display provision job succeeded
  ansible.builtin.debug:
    msg: "Provision job succeeded"
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Wait for ComputeInstance to reach Running phase
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ test_instance_name }}
      -n {{ test_namespace }}
      -o jsonpath='{.status.phase}' 2>/dev/null || echo ""
  register: phase_poll
  changed_when: false
  until: phase_poll.stdout == 'Running'
  retries: "{{ (provision_timeout / status_poll_interval) | int }}"
  delay: "{{ status_poll_interval }}"

- name: Verify ComputeInstance is Running
  ansible.builtin.assert:
    that:
      - phase_poll.stdout == 'Running'
    fail_msg: "ComputeInstance did not reach Running state, current: {{ phase_poll.stdout }}"
    success_msg: "ComputeInstance reached Running state with explicit API fields"

- name: Get VirtualMachine namespace
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ test_instance_name }}
      -n {{ test_namespace }}
      -o jsonpath='{.status.virtualMachineReference.namespace}'
  register: vm_namespace_result
  changed_when: false

- name: Test runStrategy - Change from Always to Halted
  block:
    - name: Get current runStrategy value
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          -o jsonpath='{.spec.runStrategy}'
      register: initial_run_strategy
      changed_when: false

    - name: Display initial runStrategy
      ansible.builtin.debug:
        msg: "Initial runStrategy: {{ initial_run_strategy.stdout }}"

    - name: Patch runStrategy to Halted
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin patch computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          --type=merge
          -p '{"spec":{"runStrategy":"Halted"}}'
      register: patch_halted_result
      changed_when: patch_halted_result.rc == 0

    - name: Wait for VirtualMachine to stop
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get virtualmachine {{ test_instance_name }}
          -n {{ vm_namespace_result.stdout }}
          -o jsonpath='{.status.printableStatus}'
      register: vm_status_check
      until: vm_status_check.stdout == "Stopped"
      retries: "{{ (vm_state_change_timeout / status_poll_interval) | int }}"
      delay: "{{ status_poll_interval }}"
      changed_when: false

    - name: Verify VirtualMachine spec.running is false
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get virtualmachine {{ test_instance_name }}
          -n {{ vm_namespace_result.stdout }}
          -o jsonpath='{.spec.running}'
      register: vm_running_check
      changed_when: false

    - name: Assert VM is stopped
      ansible.builtin.assert:
        that:
          - vm_running_check.stdout == "false"
          - vm_status_check.stdout == "Stopped"
        fail_msg: |
          VM did not stop correctly:
          - spec.running: {{ vm_running_check.stdout }}
          - status.printableStatus: {{ vm_status_check.stdout }}
        success_msg: "VM successfully stopped (runStrategy=Halted)"

    - name: Verify VirtualMachineInstance is terminated
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get virtualmachineinstance {{ test_instance_name }}
          -n {{ vm_namespace_result.stdout }}
          2>&1
      register: vmi_check
      failed_when: false
      changed_when: false

    - name: Assert VMI is not found
      ansible.builtin.assert:
        that:
          - "'NotFound' in vmi_check.stderr or vmi_check.rc != 0"
        fail_msg: "VirtualMachineInstance still exists after VM stopped"
        success_msg: "VirtualMachineInstance terminated successfully"

    - name: Log successful VM stop
      ansible.builtin.debug:
        msg: "✓ Test PASSED: runStrategy=Halted successfully stopped the VM"

- name: Test runStrategy - Change from Halted to Always
  block:
    - name: Patch runStrategy to Always
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin patch computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          --type=merge
          -p '{"spec":{"runStrategy":"Always"}}'
      register: patch_always_result
      changed_when: patch_always_result.rc == 0

    - name: Wait for VirtualMachine to start
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get virtualmachine {{ test_instance_name }}
          -n {{ vm_namespace_result.stdout }}
          -o jsonpath='{.status.printableStatus}'
      register: vm_status_running_check
      until: vm_status_running_check.stdout == "Running"
      retries: "{{ (vm_state_change_timeout / status_poll_interval) | int }}"
      delay: "{{ status_poll_interval }}"
      changed_when: false

    - name: Verify VirtualMachine spec.running is true
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get virtualmachine {{ test_instance_name }}
          -n {{ vm_namespace_result.stdout }}
          -o jsonpath='{.spec.running}'
      register: vm_running_true_check
      changed_when: false

    - name: Assert VM is running
      ansible.builtin.assert:
        that:
          - vm_running_true_check.stdout == "true"
          - vm_status_running_check.stdout == "Running"
        fail_msg: |
          VM did not start correctly:
          - spec.running: {{ vm_running_true_check.stdout }}
          - status.printableStatus: {{ vm_status_running_check.stdout }}
        success_msg: "VM successfully started (runStrategy=Always)"

    - name: Wait for VirtualMachineInstance to be running
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get virtualmachineinstance {{ test_instance_name }}
          -n {{ vm_namespace_result.stdout }}
          -o jsonpath='{.status.phase}'
      register: vmi_phase_check
      until: vmi_phase_check.stdout == "Running"
      retries: "{{ (vm_state_change_timeout / status_poll_interval) | int }}"
      delay: "{{ status_poll_interval }}"
      changed_when: false

    - name: Assert VMI is running
      ansible.builtin.assert:
        that:
          - vmi_phase_check.stdout == "Running"
        fail_msg: "VirtualMachineInstance did not start"
        success_msg: "VirtualMachineInstance started successfully"

    - name: Log successful VM start
      ansible.builtin.debug:
        msg: "✓ Test PASSED: runStrategy=Always successfully started the VM"

- name: Test immutability - Attempt to change cores (should fail)
  block:
    - name: Get current cores value
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin get computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          -o jsonpath='{.spec.cores}'
      register: original_cores
      changed_when: false

    - name: Attempt to patch cores field
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin patch computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          --type=merge
          -p '{"spec":{"cores":8}}'
      register: patch_cores_result
      failed_when: false
      changed_when: false

    - name: Verify cores patch was rejected
      ansible.builtin.assert:
        that:
          - patch_cores_result.rc != 0
          - "'cores is immutable' in patch_cores_result.stderr"
        fail_msg: "Cores field was allowed to change - immutability validation failed!"
        success_msg: "✓ Test PASSED: cores field is immutable (patch rejected)"

- name: Test immutability - Attempt to change memoryGiB (should fail)
  block:
    - name: Attempt to patch memoryGiB field
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin patch computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          --type=merge
          -p '{"spec":{"memoryGiB":16}}'
      register: patch_memory_result
      failed_when: false
      changed_when: false

    - name: Verify memoryGiB patch was rejected
      ansible.builtin.assert:
        that:
          - patch_memory_result.rc != 0
          - "'memoryGiB is immutable' in patch_memory_result.stderr"
        fail_msg: "MemoryGiB field was allowed to change - immutability validation failed!"
        success_msg: "✓ Test PASSED: memoryGiB field is immutable (patch rejected)"

- name: Test immutability - Attempt to change image (should fail)
  block:
    - name: Attempt to patch image field
      ansible.builtin.shell:
        cmd: >
          kubectl --as system:admin patch computeinstance {{ test_instance_name }}
          -n {{ test_namespace }}
          --type=merge
          -p '{"spec":{"image":{"sourceRef":"quay.io/fedora/fedora:latest"}}}'
      register: patch_image_result
      failed_when: false
      changed_when: false

    - name: Verify image patch was rejected
      ansible.builtin.assert:
        that:
          - patch_image_result.rc != 0
          - "'image is immutable' in patch_image_result.stderr"
        fail_msg: "Image field was allowed to change - immutability validation failed!"
        success_msg: "✓ Test PASSED: image field is immutable (patch rejected)"

- name: Cleanup - Delete test ComputeInstance
  ansible.builtin.command:
    cmd: kubectl --as system:admin delete computeinstance {{ test_instance_name }} -n {{ test_namespace }}
  register: delete_result
  changed_when: delete_result.rc == 0
  failed_when: false

- name: Wait for ComputeInstance to be deleted
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ test_instance_name }}
      -n {{ test_namespace }} 2>&1
  register: delete_check
  changed_when: false
  until: "'NotFound' in delete_check.stderr or delete_check.rc != 0"
  retries: 60
  delay: 5
  failed_when: false

- name: Remove temporary manifest directory
  ansible.builtin.file:
    path: "{{ temp_dir.path }}"
    state: absent

- name: Log successful API fields test completion
  ansible.builtin.lineinfile:
    path: "{{ testing_workspace }}/test-execution.log"
    line: |
      [{{ ansible_date_time.iso8601 }}] SUCCESS: ComputeInstance {{ test_instance_name }} API fields test completed
      - runStrategy mutability: PASSED (VM stopped and restarted)
      - cores immutability: PASSED (patch rejected)
      - memoryGiB immutability: PASSED (patch rejected)
      - image immutability: PASSED (patch rejected)
    create: true
    mode: "0644"

- name: Display test summary
  ansible.builtin.debug:
    msg: |
      ========================================
      API Fields Test Summary
      ========================================
      ComputeInstance: {{ test_instance_name }}

      ✓ Created with explicit API fields (not templateParameters)
      ✓ Provisioned and reached Running state
      ✓ runStrategy Halted: VM stopped successfully
      ✓ runStrategy Always: VM started successfully
      ✓ cores immutability: Enforced
      ✓ memoryGiB immutability: Enforced
      ✓ image immutability: Enforced
      ✓ Cleanup: ComputeInstance deleted

      All tests PASSED!
      ========================================
