---
- name: Create VM via fulfillment-cli (no-args)
  ansible.builtin.command:
    cmd: >
      {{ fulfillment_cli_path }} create virtualmachine
      --template {{ template }}
  register: test_vm_creation_vm_creation_result
  changed_when: test_vm_creation_vm_creation_result.rc == 0

- name: Save VM ID
  ansible.builtin.set_fact:
    vm_order_uuid: '{{ test_vm_creation_vm_creation_result.stdout | regex_findall("''([^'']+)''") | first }}'

- name: Verify VM registration via gRPC call
  ansible.builtin.command:
    cmd: >
      grpcurl -insecure
      -H "Authorization: Bearer {{ fulfillment_cli_base_grpc_token_result.stdout }}"
      {{ fulfillment_address }}
      private.v1.VirtualMachines/List
  register: test_vm_creation_vm_verification_result
  changed_when: false

- name: Collect list of VM uuids
  ansible.builtin.set_fact:
    known_ids: "{{ test_vm_creation_vm_verification_result.stdout | from_json | json_query('items[].id') | map('trim') | list }}"

- name: Check if VM appears in gRPC response
  ansible.builtin.assert:
    that:
      - vm_order_uuid in known_ids
    fail_msg: VM {{ test_vm_creation_vm_creation_result.stdout }} not found in gRPC VM list response
    success_msg: VM {{ test_vm_creation_vm_creation_result.stdout }} successfully registered and verified via gRPC

- name: Collect VM list
  ansible.builtin.command:
    cmd: >
      grpcurl -insecure
      -H "Authorization: Bearer {{ fulfillment_cli_base_grpc_token_result.stdout }}"
      {{ fulfillment_address }}
      private.v1.VirtualMachines/List
  register: vm_status_check
  until:
    - vm_status_check.rc == 0
    - vm_status_check.stdout | from_json | json_query('status.conditions') is defined
    - >
      vm_status_check.stdout
      | from_json
      | json_query("items[?id=='%s']" % vm_order_uuid)
      | map(attribute='status.state')
      | list
      | first
      == "VIRTUAL_MACHINE_STATE_READY"
  retries: "{{ (vm_ready_timeout / check_interval) | int }}"
  delay: "{{ check_interval }}"
  changed_when: false

- name: Log successful VM creation and verification
  ansible.builtin.lineinfile:
    path: "{{ testing_workspace }}/test-execution.log"
    line: |
      [{{ ansible_date_time.iso8601 }}] SUCCESS: VM {{ vm_order_uuid }} created and verified successfully
      VM is ready and running
