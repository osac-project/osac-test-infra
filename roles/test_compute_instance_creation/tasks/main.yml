---
- name: Create ComputeInstance via fulfillment-cli
  ansible.builtin.command:
    cmd: >
      {{ fulfillment_cli_path }} create computeinstance
      --template {{ template }}
  register: test_compute_instance_creation_result
  changed_when: test_compute_instance_creation_result.rc == 0

- name: Save ComputeInstance ID
  ansible.builtin.set_fact:
    compute_instance_order_uuid: '{{ test_compute_instance_creation_result.stdout | regex_findall("''([^'']+)''") | first }}'

- name: Verify ComputeInstance registration via gRPC call
  ansible.builtin.command:
    cmd: >
      grpcurl -insecure
      -H "Authorization: Bearer {{ fulfillment_cli_base_grpc_token_result.stdout }}"
      {{ fulfillment_address }}
      fulfillment.v1.ComputeInstances/List
  register: test_compute_instance_verification_result
  changed_when: false

- name: Collect list of ComputeInstance UUIDs
  ansible.builtin.set_fact:
    known_ids: "{{ test_compute_instance_verification_result.stdout | from_json | json_query('items[].id') | map('trim') | list }}"

- name: Check if ComputeInstance appears in gRPC response
  ansible.builtin.assert:
    that:
      - compute_instance_order_uuid in known_ids
    fail_msg: ComputeInstance {{ test_compute_instance_creation_result.stdout }} not found in gRPC ComputeInstance list response
    success_msg: ComputeInstance {{ test_compute_instance_creation_result.stdout }} successfully registered and verified via gRPC

# Job status verification - provision flow
- name: Get ComputeInstance name from Kubernetes
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance
      -n {{ test_namespace }}
      -l cloudkit.openshift.io/computeinstance-uuid={{ compute_instance_order_uuid }}
      -o jsonpath='{.items[0].metadata.name}'
  register: ci_name_result
  changed_when: false

- name: Display ComputeInstance name
  ansible.builtin.debug:
    msg: "ComputeInstance name: {{ ci_name_result.stdout }}"

- name: Poll for provision job to appear
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .jobID // ""
      '
  register: provision_job_poll
  changed_when: false
  until: provision_job_poll.stdout != ""
  retries: 30
  delay: 2

- name: Display provision job ID
  ansible.builtin.debug:
    msg: "Provision job started: {{ provision_job_poll.stdout }}"

- name: Poll for provision job to be Running
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .state // ""
      '
  register: provision_state_poll
  changed_when: false
  until: provision_state_poll.stdout in ['Running', 'Succeeded']
  retries: 30
  delay: 2
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Display provision job running
  ansible.builtin.debug:
    msg: "Provision job state: {{ provision_state_poll.stdout }}"
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Skip provision job state polling for EDA provider
  ansible.builtin.debug:
    msg: "EDA provider detected (job ID: {{ provision_job_poll.stdout }}), skipping job state polling"
  when: provision_job_poll.stdout.startswith('eda-webhook')

- name: Poll for provision job to succeed
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .state // ""
      '
  register: provision_success_poll
  changed_when: false
  until: provision_success_poll.stdout == 'Succeeded'
  retries: 60
  delay: 5
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Display provision job succeeded
  ansible.builtin.debug:
    msg: "Provision job succeeded"
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Poll for ComputeInstance to reach Running state
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o jsonpath='{.status.phase}' 2>/dev/null || echo ""
  register: phase_poll
  changed_when: false
  until: phase_poll.stdout == 'Running'
  retries: 300
  delay: 2

- name: Verify ComputeInstance is Running
  ansible.builtin.assert:
    that:
      - phase_poll.stdout == 'Running'
    fail_msg: "ComputeInstance did not reach Running state, current: {{ phase_poll.stdout }}"
    success_msg: "ComputeInstance reached Running state"

- name: Log successful ComputeInstance creation and verification
  ansible.builtin.lineinfile:
    path: "{{ testing_workspace }}/test-execution.log"
    line: |
      [{{ ansible_date_time.iso8601 }}] SUCCESS: ComputeInstance {{ compute_instance_order_uuid }} created, provision job {{ provision_job_poll.stdout }} succeeded, Running state reached
