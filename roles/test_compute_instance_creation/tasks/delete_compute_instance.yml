---
- name: Delete ComputeInstance via fulfillment-cli
  ansible.builtin.command:
    cmd: >
      {{ fulfillment_cli_path }} delete computeinstance
      {{ compute_instance_order_uuid }}
  register: test_compute_instance_deletion_result
  changed_when: test_compute_instance_deletion_result.rc == 0

- name: Display deletion initiated
  ansible.builtin.debug:
    msg: "Deletion initiated for ComputeInstance {{ compute_instance_order_uuid }}"

# Job status verification - deprovision flow
- name: Poll for deprovision job to appear
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o jsonpath='{.status.deprovisionJob.id}' 2>/dev/null || echo ""
  register: deprovision_job_poll
  changed_when: false
  until: deprovision_job_poll.stdout != ""
  retries: 30
  delay: 2

- name: Display deprovision job ID
  ansible.builtin.debug:
    msg: "Deprovision job started: {{ deprovision_job_poll.stdout }}"

- name: Poll for deprovision job to be Running
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o jsonpath='{.status.deprovisionJob.state}' 2>/dev/null || echo ""
  register: deprovision_state_poll
  changed_when: false
  until: deprovision_state_poll.stdout in ['Running', 'Succeeded']
  retries: 30
  delay: 2
  when: deprovision_job_poll.stdout != 'eda-webhook'

- name: Display deprovision job running
  ansible.builtin.debug:
    msg: "Deprovision job state: {{ deprovision_state_poll.stdout }}"
  when: deprovision_job_poll.stdout != 'eda-webhook'

- name: Skip deprovision job state polling for EDA provider
  ansible.builtin.debug:
    msg: "EDA provider detected (job ID: eda-webhook), skipping job state polling"
  when: deprovision_job_poll.stdout == 'eda-webhook'

- name: Poll for ComputeInstance CR to be deleted
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }} 2>&1
  register: cr_deletion_poll
  changed_when: false
  failed_when: false
  until: "'NotFound' in cr_deletion_poll.stderr or 'not found' in cr_deletion_poll.stderr"
  retries: 60
  delay: 3

- name: Display CR deletion confirmation
  ansible.builtin.debug:
    msg: "ComputeInstance CR {{ ci_name_result.stdout }} deleted from Kubernetes"

# Verify deletion via gRPC
- name: Verify ComputeInstance deletion via gRPC call
  ansible.builtin.command:
    cmd: >
      grpcurl -insecure
      -H "Authorization: Bearer {{ fulfillment_cli_base_grpc_token_result.stdout }}"
      {{ fulfillment_address }}
      fulfillment.v1.ComputeInstances/List
  register: test_compute_instance_verification_result
  changed_when: false

- name: Collect list of ComputeInstance UUIDs
  ansible.builtin.set_fact:
    known_ids: "{{ test_compute_instance_verification_result.stdout | from_json | json_query('items[].id') | map('trim') | list }}"

- name: Check if ComputeInstance was deleted
  ansible.builtin.assert:
    that:
      - compute_instance_order_uuid not in known_ids
    fail_msg: ComputeInstance {{ compute_instance_order_uuid }} deletion failed
    success_msg: ComputeInstance {{ compute_instance_order_uuid }} successfully deleted

- name: Log ComputeInstance cleanup completion
  ansible.builtin.debug:
    msg: "Successfully cleaned up test ComputeInstance {{ compute_instance_order_uuid }}, deprovision job {{ deprovision_job_poll.stdout }}"
