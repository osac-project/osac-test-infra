---
# E2E test: Create ComputeInstance via fulfillment-cli with explicit spec fields
# Verifies the full stack: CLI -> fulfillment-service -> operator -> provisioning

- name: Display test configuration
  ansible.builtin.debug:
    msg: |
      Creating ComputeInstance via CLI with explicit spec fields
      Template: {{ template }}
      Cores: {{ test_cores }}
      Memory: {{ test_memory_gib }} GiB
      Boot disk: {{ test_boot_disk_size }} GiB
      Image: {{ test_image }}
      Run strategy: {{ test_run_strategy }}

- name: Create ComputeInstance via fulfillment-cli with explicit fields
  ansible.builtin.command:
    cmd: >
      {{ fulfillment_cli_path }} create computeinstance
      --template {{ template }}
      --cores {{ test_cores }}
      --memory-gib {{ test_memory_gib }}
      --boot-disk-size {{ test_boot_disk_size }}
      --image {{ test_image }}
      --image-source-type {{ test_image_source_type }}
      --run-strategy {{ test_run_strategy }}
  register: cli_create_result
  changed_when: cli_create_result.rc == 0

- name: Display CLI output
  ansible.builtin.debug:
    msg: "{{ cli_create_result.stdout }}"

- name: Save ComputeInstance ID
  ansible.builtin.set_fact:
    compute_instance_id: >-
      {{ cli_create_result.stdout | regex_findall("'([^']+)'") | first }}

- name: Display ComputeInstance ID
  ansible.builtin.debug:
    msg: "ComputeInstance ID: {{ compute_instance_id }}"

- name: Verify ComputeInstance exists via gRPC
  ansible.builtin.command:
    cmd: >
      grpcurl -insecure
      -H "Authorization: Bearer {{ fulfillment_cli_base_grpc_token_result.stdout }}"
      {{ fulfillment_address }}
      fulfillment.v1.ComputeInstances/List
  register: grpc_list_result
  changed_when: false

- name: Check ComputeInstance appears in gRPC response
  ansible.builtin.assert:
    that:
      - compute_instance_id in (grpc_list_result.stdout | from_json | json_query('items[].id') | list)
    fail_msg: "ComputeInstance {{ compute_instance_id }} not found in gRPC response"
    success_msg: "ComputeInstance {{ compute_instance_id }} verified via gRPC"

- name: Get ComputeInstance name from Kubernetes
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance
      -n {{ test_namespace }}
      -l osac.openshift.io/computeinstance-uuid={{ compute_instance_id }}
      -o jsonpath='{.items[0].metadata.name}'
  register: ci_name_result
  changed_when: false
  retries: 10
  delay: 2
  until: ci_name_result.stdout != ""

- name: Display ComputeInstance name
  ansible.builtin.debug:
    msg: "ComputeInstance Kubernetes name: {{ ci_name_result.stdout }}"

- name: Verify explicit fields on Kubernetes resource
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o json
  register: ci_spec_result
  changed_when: false

- name: Assert explicit fields were set correctly
  ansible.builtin.assert:
    that:
      - (ci_spec_result.stdout | from_json).spec.cores == test_cores
      - (ci_spec_result.stdout | from_json).spec.memoryGiB == test_memory_gib
      - (ci_spec_result.stdout | from_json).spec.bootDisk.sizeGiB == test_boot_disk_size
      - (ci_spec_result.stdout | from_json).spec.image.sourceRef == test_image
      - (ci_spec_result.stdout | from_json).spec.runStrategy == test_run_strategy
    fail_msg: "Explicit fields not set correctly on Kubernetes resource"
    success_msg: "All explicit fields verified on Kubernetes resource"

- name: Wait for provision job to appear
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .jobID // ""
      '
  register: provision_job_poll
  changed_when: false
  until: provision_job_poll.stdout != ""
  retries: 30
  delay: 2

- name: Display provision job ID
  ansible.builtin.debug:
    msg: "Provision job started: {{ provision_job_poll.stdout }}"

- name: Wait for provision job to succeed
  ansible.builtin.shell:
    cmd: >
      set -o pipefail;
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o json 2>/dev/null | jq -r '
        .status.jobs // [] |
        map(select(.type == "provision")) |
        sort_by(.timestamp) | reverse | first | .state // ""
      '
  register: provision_success_poll
  changed_when: false
  until: provision_success_poll.stdout == 'Succeeded'
  retries: "{{ (provision_timeout / status_poll_interval) | int }}"
  delay: "{{ status_poll_interval }}"
  when: not provision_job_poll.stdout.startswith('eda-webhook')

- name: Wait for ComputeInstance to reach Running phase
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }}
      -o jsonpath='{.status.phase}' 2>/dev/null || echo ""
  register: phase_poll
  changed_when: false
  until: phase_poll.stdout == 'Running'
  retries: "{{ (provision_timeout / status_poll_interval) | int }}"
  delay: "{{ status_poll_interval }}"

- name: Verify ComputeInstance is Running
  ansible.builtin.assert:
    that:
      - phase_poll.stdout == 'Running'
    fail_msg: "ComputeInstance did not reach Running state, current: {{ phase_poll.stdout }}"
    success_msg: "ComputeInstance reached Running state"

- name: Cleanup - Delete ComputeInstance via CLI
  ansible.builtin.command:
    cmd: >
      {{ fulfillment_cli_path }} delete computeinstance {{ compute_instance_id }}
  register: cli_delete_result
  changed_when: cli_delete_result.rc == 0
  failed_when: false

- name: Wait for ComputeInstance to be deleted
  ansible.builtin.shell:
    cmd: >
      kubectl --as system:admin get computeinstance {{ ci_name_result.stdout }}
      -n {{ test_namespace }} 2>&1
  register: delete_check
  changed_when: false
  until: "'NotFound' in delete_check.stderr or delete_check.rc != 0"
  retries: 60
  delay: 5
  failed_when: false

- name: Log test completion
  ansible.builtin.lineinfile:
    path: "{{ testing_workspace }}/test-execution.log"
    line: |
      [{{ ansible_date_time.iso8601 }}] SUCCESS: CLI explicit fields test completed
      - ComputeInstance ID: {{ compute_instance_id }}
      - Explicit fields verified: cores={{ test_cores }}, memoryGiB={{ test_memory_gib }}, bootDisk={{ test_boot_disk_size }}
      - Provisioned and reached Running state
      - Deleted via CLI
    create: true
    mode: "0644"

- name: Display test summary
  ansible.builtin.debug:
    msg: |
      ========================================
      CLI Explicit Fields Test Summary
      ========================================
      ComputeInstance ID: {{ compute_instance_id }}

      Passed:
        - Created via CLI with explicit fields
        - Verified in gRPC API
        - Explicit fields set correctly on Kubernetes resource
        - Provisioned and reached Running state
        - Deleted via CLI
      ========================================
