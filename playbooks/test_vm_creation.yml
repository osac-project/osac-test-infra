---
# OSAC E2E Test: VM Creation
# This playbook tests the creation and verification of virtual_machines

- name: OSAC VM Creation Test
  hosts: localhost
  gather_facts: true
  vars:
    test_name: VM Creation Test
    test_description: Test creating and verifying a VM with fulfillment-cli
  tasks:
    - name: Display test information
      ansible.builtin.debug:
        msg: |
          {{ test_name }}
          ==========================================
          Description: {{ test_description }}
          Namespace: {{ test_namespace }}
          Timestamp: {{ ansible_date_time.iso8601 }}
          ==========================================

    - name: Execute VM creation test
      block:
        - name: Run VM creation test
          ansible.builtin.include_role:
            name: test_vm_creation
          vars:
            vm_template: cloudkit.templates.ocp_virt_vm

      rescue:
        - name: Log test failure
          ansible.builtin.lineinfile:
            path: "{{ testing_workspace }}/test-execution.log"
            line: "[{{ ansible_date_time.iso8601 }}] FAILED: VM creation test failed"
            create: true
            mode: "0644"

        - name: Re-raise the error
          ansible.builtin.fail:
            msg: VM creation test failed

    - name: Execute VM cleanup
      ansible.builtin.include_role:
        name: test_vm_creation
        tasks_from: delete_vm
      vars:
        vm_id: "{{ test_vm_id }}"
